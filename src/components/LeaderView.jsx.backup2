import React, { useState, useEffect } from 'react'
import { databaseService } from '../supabase'

export default function LeaderView({ user, onSuccess }) {
  const [expenses, setExpenses] = useState([])
  const [customers, setCustomers] = useState([])
  const [approvedExpenses, setApprovedExpenses] = useState([])
  const [loading, setLoading] = useState(true)
  const [selectedExpense, setSelectedExpense] = useState(null)
  const [showModal, setShowModal] = useState(false)
  const [activeTab, setActiveTab] = useState('expenses')
  const [showExpenseModal, setShowExpenseModal] = useState(false)
  const [expenseForm, setExpenseForm] = useState({
    amount: '',
    purpose: '',
    category: '',
    type: '',
    note: '',
    paymentMethod: 'é“¶è¡Œè½¬è´¦',
    payeeName: '',
    payeeContact: '',
    payeeAccount: '',
    payeeBank: '',
    receiptImage: null,
    receiptImageUrl: '',
    receiptImagePath: ''
  })
  const [expenseStep, setExpenseStep] = useState(1)
  
  // ç”³è¯·ç±»å‹åˆ†ç±»
  const expenseCategories = {
    'è®¾å¤‡è´¹ç”¨': {
      label: 'è®¾å¤‡è´¹ç”¨',
      icon: 'ğŸ’»',
      types: [
        { value: 'æ‰‹æœº', label: 'æ‰‹æœº', icon: 'ğŸ“±' },
        { value: 'ç”µè„‘', label: 'ç”µè„‘', icon: 'ğŸ’»' },
        { value: 'å¹³æ¿', label: 'å¹³æ¿', icon: 'ğŸ“±' },
        { value: 'æ‰“å°æœº', label: 'æ‰“å°æœº', icon: 'ğŸ–¨ï¸' },
        { value: 'æœåŠ¡å™¨', label: 'æœåŠ¡å™¨', icon: 'ğŸ–¥ï¸' },
        { value: 'ç½‘ç»œè®¾å¤‡', label: 'ç½‘ç»œè®¾å¤‡', icon: 'ğŸŒ' },
        { value: 'å…¶ä»–è®¾å¤‡', label: 'å…¶ä»–è®¾å¤‡', icon: 'ğŸ”§' }
      ]
    },
    'ç‰©ä¸šè´¹ç”¨': {
      label: 'ç‰©ä¸šè´¹ç”¨',
      icon: 'ğŸ¢',
      types: [
        { value: 'æˆ¿ç§Ÿ', label: 'æˆ¿ç§Ÿ', icon: 'ğŸ ' },
        { value: 'æ°´ç”µè´¹', label: 'æ°´ç”µè´¹', icon: 'âš¡' },
        { value: 'ç½‘ç»œè´¹', label: 'ç½‘ç»œè´¹', icon: 'ğŸŒ' },
        { value: 'ç‰©ä¸šè´¹', label: 'ç‰©ä¸šè´¹', icon: 'ğŸ¢' },
        { value: 'åœè½¦è´¹', label: 'åœè½¦è´¹', icon: 'ğŸ…¿ï¸' },
        { value: 'æ¸…æ´è´¹', label: 'æ¸…æ´è´¹', icon: 'ğŸ§¹' },
        { value: 'å…¶ä»–ç‰©ä¸š', label: 'å…¶ä»–ç‰©ä¸š', icon: 'ğŸ¢' }
      ]
    },
    'å·®æ—…è´¹ç”¨': {
      label: 'å·®æ—…è´¹ç”¨',
      icon: 'âœˆï¸',
      types: [
        { value: 'äº¤é€šè´¹', label: 'äº¤é€šè´¹', icon: 'ğŸš—' },
        { value: 'ä½å®¿è´¹', label: 'ä½å®¿è´¹', icon: 'ğŸ¨' },
        { value: 'é¤é¥®è´¹', label: 'é¤é¥®è´¹', icon: 'ğŸ½ï¸' },
        { value: 'æœºç¥¨è´¹', label: 'æœºç¥¨è´¹', icon: 'âœˆï¸' },
        { value: 'ç«è½¦ç¥¨', label: 'ç«è½¦ç¥¨', icon: 'ğŸš„' },
        { value: 'å‡ºç§Ÿè½¦è´¹', label: 'å‡ºç§Ÿè½¦è´¹', icon: 'ğŸš•' },
        { value: 'å…¶ä»–å·®æ—…', label: 'å…¶ä»–å·®æ—…', icon: 'ğŸ’' }
      ]
    },
    'åŠå…¬è´¹ç”¨': {
      label: 'åŠå…¬è´¹ç”¨',
      icon: 'ğŸ“‹',
      types: [
        { value: 'æ–‡å…·ç”¨å“', label: 'æ–‡å…·ç”¨å“', icon: 'âœï¸' },
        { value: 'åŠå…¬è½¯ä»¶', label: 'åŠå…¬è½¯ä»¶', icon: 'ğŸ’¿' },
        { value: 'åŠå…¬å®¶å…·', label: 'åŠå…¬å®¶å…·', icon: 'ğŸª‘' },
        { value: 'åŠå…¬è€—æ', label: 'åŠå…¬è€—æ', icon: 'ğŸ“„' },
        { value: 'å¿«é€’è´¹', label: 'å¿«é€’è´¹', icon: 'ğŸ“¦' },
        { value: 'å°åˆ·è´¹', label: 'å°åˆ·è´¹', icon: 'ğŸ–¨ï¸' },
        { value: 'å…¶ä»–åŠå…¬', label: 'å…¶ä»–åŠå…¬', icon: 'ğŸ“‹' }
      ]
    },
    'åŸ¹è®­è´¹ç”¨': {
      label: 'åŸ¹è®­è´¹ç”¨',
      icon: 'ğŸ“',
      types: [
        { value: 'è¯¾ç¨‹è´¹ç”¨', label: 'è¯¾ç¨‹è´¹ç”¨', icon: 'ğŸ“š' },
        { value: 'åŸ¹è®­ææ–™', label: 'åŸ¹è®­ææ–™', icon: 'ğŸ“–' },
        { value: 'è€ƒè¯•è´¹ç”¨', label: 'è€ƒè¯•è´¹ç”¨', icon: 'ğŸ“' },
        { value: 'è®¤è¯è´¹ç”¨', label: 'è®¤è¯è´¹ç”¨', icon: 'ğŸ†' },
        { value: 'ä¼šè®®è´¹ç”¨', label: 'ä¼šè®®è´¹ç”¨', icon: 'ğŸ‘¥' },
        { value: 'ç ”è®¨ä¼š', label: 'ç ”è®¨ä¼š', icon: 'ğŸ¤' },
        { value: 'å…¶ä»–åŸ¹è®­', label: 'å…¶ä»–åŸ¹è®­', icon: 'ğŸ“' }
      ]
    },
    'è¥é”€è´¹ç”¨': {
      label: 'è¥é”€è´¹ç”¨',
      icon: 'ğŸ“¢',
      types: [
        { value: 'å¹¿å‘Šè´¹', label: 'å¹¿å‘Šè´¹', icon: 'ğŸ“º' },
        { value: 'æ¨å¹¿è´¹', label: 'æ¨å¹¿è´¹', icon: 'ğŸ“¢' },
        { value: 'æ´»åŠ¨è´¹', label: 'æ´»åŠ¨è´¹', icon: 'ğŸ‰' },
        { value: 'ç¤¼å“è´¹', label: 'ç¤¼å“è´¹', icon: 'ğŸ' },
        { value: 'å®£ä¼ ææ–™', label: 'å®£ä¼ ææ–™', icon: 'ğŸ“„' },
        { value: 'å±•ä¼šè´¹ç”¨', label: 'å±•ä¼šè´¹ç”¨', icon: 'ğŸ¢' },
        { value: 'å…¶ä»–è¥é”€', label: 'å…¶ä»–è¥é”€', icon: 'ğŸ“¢' }
      ]
    }
  }

  useEffect(() => {
    loadData()
  }, [user])

  const loadData = async () => {
    setLoading(true)
    try {
      console.log('ç»„é•¿åŠ è½½æ•°æ®ï¼Œç”¨æˆ·ä¿¡æ¯:', user)
      
      // ç»„é•¿å¯ä»¥çœ‹åˆ°è‡ªå·±ä¸‹çº§çš„ç”³è¯·è®°å½•å’Œè‡ªå·±æäº¤çš„ç”³è¯·
      const subordinateExpenses = await databaseService.getSubordinateExpenses(user.id, user.role, { 
        status: 'submitted'
      })
      
      // è·å–ç»„é•¿è‡ªå·±æäº¤çš„ç”³è¯·
      const myExpenses = await databaseService.getExpenses({ 
        created_by: user.id,
        status: ['waiting_supervisor', 'waiting_finance', 'paid', 'rejected']
      })
      
      // åˆå¹¶æ•°æ®ï¼Œé¿å…é‡å¤
      const allExpenses = [...subordinateExpenses]
      myExpenses.forEach(myExpense => {
        if (!allExpenses.find(exp => exp.id === myExpense.id)) {
          allExpenses.push(myExpense)
        }
      })
      
      console.log('ç»„é•¿ç”³è¯·æ•°æ®:', allExpenses)
      setExpenses(allExpenses)
      
      // è·å–æœ¬æœˆå·²å®¡æ‰¹çš„ç”³è¯·
      const approvedData = await databaseService.getSubordinateExpenses(user.id, user.role, { 
        status: 'waiting_supervisor'
      })
      console.log('æœ¬æœˆå·²å®¡æ‰¹æ•°æ®:', approvedData)
      setApprovedExpenses(approvedData)
      
      // ç»„é•¿å¯ä»¥çœ‹åˆ°æ‰€æœ‰å®¢æˆ·æ•°æ®
      const customersData = await databaseService.getCustomers()
      console.log('å®¢æˆ·æ•°æ®:', customersData)
      setCustomers(customersData)
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleApproval = async (expenseId, action, comment = '') => {
    try {
      console.log('å¼€å§‹å®¡æ‰¹æ“ä½œ:', { expenseId, action, comment, userId: user.id, user: user })
      
      // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
      if (!user || !user.id) {
        alert('ç”¨æˆ·ä¿¡æ¯é”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•')
        return
      }
      
      const newStatus = action === 'approve' ? 'waiting_supervisor' : 'rejected'
      console.log('å‡†å¤‡æ›´æ–°çŠ¶æ€:', newStatus)
      
      const result = await databaseService.updateExpenseStatus(
        expenseId, 
        newStatus, 
        action, 
        comment, 
        user.id
      )
      
      console.log('å®¡æ‰¹ç»“æœ:', result)
      
      if (result) {
        alert(action === 'approve' ? 'å·²æ‰¹å‡†ç”³è¯·ï¼' : 'å·²æ‹’ç»ç”³è¯·ï¼')
        loadData()
        onSuccess?.()
        setShowModal(false)
        setSelectedExpense(null)
      } else {
        console.error('å®¡æ‰¹æ“ä½œè¿”å›null')
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    } catch (error) {
      console.error('å®¡æ‰¹æ“ä½œå¤±è´¥:', error)
      alert(`æ“ä½œå¤±è´¥: ${error.message || 'è¯·é‡è¯•'}`)
    }
  }

  const openModal = (expense) => {
    setSelectedExpense(expense)
    setShowModal(true)
  }

  // æäº¤ç”³è¯·
  const handleSubmitExpense = async (e) => {
    e.preventDefault()
    try {
      const expense = {
        company_id: '550e8400-e29b-41d4-a716-446655440000',
        created_by: user.id,
        team_id: user.team_id,
        amount: parseFloat(expenseForm.amount),
        purpose: `${expenseForm.category} - ${expenseForm.type}`,
        notes: expenseForm.note,
        status: 'waiting_supervisor', // ç»„é•¿ç”³è¯·ç›´æ¥è¿›å…¥å¾…ä¸»ç®¡å®¡æ‰¹çŠ¶æ€
        attachments: {
          paymentMethod: expenseForm.paymentMethod,
          payeeName: expenseForm.payeeName,
          payeeContact: expenseForm.payeeContact,
          payeeAccount: expenseForm.payeeAccount,
          payeeBank: expenseForm.payeeBank,
          receiptImageUrl: expenseForm.receiptImageUrl,
          receiptImagePath: expenseForm.receiptImagePath,
          receiptFileName: expenseForm.receiptImage?.name || ''
        }
      }

      const result = await databaseService.addExpense(expense)
      if (result) {
        alert('ç”³è¯·æäº¤æˆåŠŸï¼')
        setShowExpenseModal(false)
        setExpenseForm({
          amount: '',
          purpose: '',
          category: '',
          type: '',
          note: '',
          paymentMethod: 'é“¶è¡Œè½¬è´¦',
          payeeName: '',
          payeeContact: '',
          payeeAccount: '',
          payeeBank: '',
          receiptImage: null,
          receiptImageUrl: '',
          receiptImagePath: ''
        })
        setExpenseStep(1)
        loadData() // é‡æ–°åŠ è½½æ•°æ®
      } else {
        alert('ç”³è¯·æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
      }
    } catch (error) {
      console.error('æäº¤ç”³è¯·å¤±è´¥:', error)
      alert('ç”³è¯·æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }


  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="loading-spinner mx-auto mb-4"></div>
          <div className="text-lg text-gray-600">åŠ è½½ä¸­...</div>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* å¤´éƒ¨ */}
      <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold mb-2">ç»„é•¿ç®¡ç†ä¸­å¿ƒ</h2>
            <p className="text-blue-100">ç®¡ç†å›¢é˜Ÿæ”¯å‡ºç”³è¯·å’Œå®¢æˆ·æ•°æ®</p>
          </div>
          <div className="text-4xl opacity-80">ğŸ‘¨â€ğŸ’¼</div>
        </div>
      </div>

      {/* æ ‡ç­¾é¡µå¯¼èˆª */}
      <div className="bg-white rounded-lg shadow-sm border border-gray-200">
        <div className="border-b border-gray-200">
          <nav className="flex space-x-8 px-6">
            {[
              { id: 'expenses', name: 'æ”¯å‡ºå®¡æ‰¹', icon: 'ğŸ’°' },
              { id: 'myExpenses', name: 'æˆ‘çš„ç”³è¯·', icon: 'ğŸ“' },
              { id: 'customers', name: 'å®¢æˆ·ç®¡ç†', icon: 'ğŸ‘¥' }
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`py-4 px-1 border-b-2 font-medium text-sm ${
                  activeTab === tab.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                <span className="mr-2">{tab.icon}</span>
                {tab.name}
              </button>
            ))}
          </nav>
        </div>
      </div>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">å¾…å®¡æ‰¹</p>
              <p className="text-2xl font-bold text-yellow-600">{expenses.length}</p>
            </div>
            <div className="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center text-2xl">
              â³
            </div>
          </div>
        </div>
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">å®¢æˆ·æ€»æ•°</p>
              <p className="text-2xl font-bold text-blue-600">{customers.length}</p>
            </div>
            <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl">
              ğŸ‘¥
            </div>
          </div>
        </div>
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">æœ¬æœˆå·²å®¡æ‰¹</p>
              <p className="text-2xl font-bold text-green-600">{approvedExpenses.length}</p>
            </div>
            <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-2xl">
              âœ…
            </div>
          </div>
        </div>
        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">å®¡æ‰¹é‡‘é¢</p>
              <p className="text-2xl font-bold text-purple-600">Â¥{expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0).toLocaleString()}</p>
            </div>
            <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl">
              ğŸ’°
            </div>
          </div>
        </div>
      </div>

      {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-200">
        <div className="px-6 py-4 border-b border-gray-200">
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-semibold text-gray-900">
              {activeTab === 'expenses' ? `å¾…å®¡æ‰¹ç”³è¯· (${expenses.length}ç¬”)` : 
               activeTab === 'myExpenses' ? `æˆ‘çš„ç”³è¯· (${expenses.filter(exp => exp.created_by === user.id).length}ç¬”)` :
               `å®¢æˆ·ç®¡ç† (${customers.length}ä¸ª)`}
            </h3>
            <div className="flex items-center space-x-2">
              <span className="text-sm text-gray-500">æ’åº:</span>
              <select className="text-sm border border-gray-300 rounded-md px-2 py-1">
                <option>æŒ‰æ—¶é—´</option>
                <option>æŒ‰é‡‘é¢</option>
                <option>æŒ‰ç”³è¯·äºº</option>
              </select>
            </div>
          </div>
        </div>
        
        <div className="p-6">
          {activeTab === 'expenses' ? (
            // æ”¯å‡ºå®¡æ‰¹å†…å®¹
            expenses.length === 0 ? (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">ğŸ“</div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">æš‚æ— å¾…å®¡æ‰¹ç”³è¯·</h3>
                <p className="text-gray-500">æ‰€æœ‰ç”³è¯·éƒ½å·²å¤„ç†å®Œæˆ</p>
              </div>
            ) : (
              <div className="space-y-4">
                {expenses.map((expense) => (
                  <div key={expense.id} className="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-all duration-300 animate-fade-in">
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <div className="flex items-center space-x-4 mb-4">
                          <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <span className="text-blue-600 font-medium">
                              {expense.creator?.name?.charAt(0) || 'U'}
                            </span>
                          </div>
                          <div className="flex-1">
                            <div className="flex items-center space-x-2 mb-1">
                              <h4 className="font-medium text-gray-900">{expense.creator?.name || 'æœªçŸ¥ç”³è¯·äºº'}</h4>
                              <span className={`px-2 py-1 text-xs rounded-full ${
                                expense.creator?.role === 'team_leader' 
                                  ? 'bg-purple-100 text-purple-700' 
                                  : 'bg-green-100 text-green-700'
                              }`}>
                                {expense.creator?.role === 'team_leader' ? 'ğŸ‘¨â€ğŸ’¼ ç»„é•¿' : 'ğŸ‘¤ å‘˜å·¥'}
                              </span>
                            </div>
                            <div className="flex items-center space-x-4 text-sm text-gray-500">
                              <span>ğŸ¢ {expense.team?.name || 'æœªçŸ¥å›¢é˜Ÿ'}</span>
                              <span>ğŸ“… {new Date(expense.applied_at).toLocaleDateString()}</span>
                            </div>
                          </div>
                          <div className="text-right">
                            <div className="text-sm text-gray-500 mb-1">å®¡æ‰¹äºº</div>
                            <div className="flex items-center space-x-2">
                              <div className="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center">
                                <span className="text-orange-600 font-medium text-sm">
                                  {user?.name?.charAt(0) || 'L'}
                                </span>
                              </div>
                              <span className="text-sm font-medium text-gray-900">{user?.name}</span>
                              <span className="px-2 py-1 text-xs bg-orange-100 text-orange-700 rounded-full">ğŸ‘¨â€ğŸ’¼ ç»„é•¿</span>
                            </div>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-6 mb-4">
                          <div>
                            <span className="text-sm font-medium text-gray-600">ç”³è¯·é‡‘é¢:</span>
                            <p className="text-xl font-bold text-gray-900">Â¥{expense.amount}</p>
                          </div>
                          <div>
                            <span className="text-sm font-medium text-gray-600">ç”¨é€”è¯´æ˜:</span>
                            <p className="text-sm text-gray-900">{expense.purpose}</p>
                          </div>
                        </div>
                        
                        {expense.notes && (
                          <div className="mb-4">
                            <span className="text-sm font-medium text-gray-600">å¤‡æ³¨:</span>
                            <p className="text-sm text-gray-900">{expense.notes}</p>
                          </div>
                        )}
                        
                        {/* AIå®¡æ ¸å»ºè®® */}
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                          <div className="flex items-center mb-2">
                            <span className="text-sm font-medium text-blue-900">ğŸ¤– AIå®¡æ ¸å»ºè®®</span>
                          </div>
                          <div className="grid grid-cols-3 gap-4 text-sm">
                            <div>
                              <span className="font-medium">å†³ç­–:</span> 
                              <span className="ml-1 text-green-600">å»ºè®®é€šè¿‡</span>
                            </div>
                            <div>
                              <span className="font-medium">åŸå› :</span> ç”³è¯·é‡‘é¢åˆç†ï¼Œç”¨é€”æ˜ç¡®
                            </div>
                            <div>
                              <span className="font-medium">ç½®ä¿¡åº¦:</span> 85%
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {/* æ“ä½œæŒ‰é’® */}
                      <div className="flex flex-col space-y-3 ml-6">
                        <button
                          onClick={() => openModal(expense)}
                          className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium transition-colors duration-200"
                        >
                          ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…
                        </button>
                        
                        {/* å¦‚æœæ˜¯è‡ªå·±æäº¤çš„ç”³è¯·ï¼Œåªæ˜¾ç¤ºçŠ¶æ€ï¼Œä¸æ˜¾ç¤ºå®¡æ‰¹æŒ‰é’® */}
                        {expense.created_by === user.id ? (
                          <div className="px-4 py-2 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium text-center">
                            {expense.status === 'waiting_supervisor' && 'â³ å¾…ä¸»ç®¡å®¡æ‰¹'}
                            {expense.status === 'waiting_finance' && 'ğŸ’° å¾…è´¢åŠ¡å®¡æ‰¹'}
                            {expense.status === 'paid' && 'âœ… å·²æ”¯ä»˜'}
                            {expense.status === 'rejected' && 'âŒ å·²æ‹’ç»'}
                          </div>
                        ) : (
                          <>
                            <button
                              onClick={() => handleApproval(expense.id, 'reject', 'ç”³è¯·ä¸ç¬¦åˆè¦æ±‚')}
                              className="px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 text-sm font-medium transition-colors duration-200"
                            >
                              âŒ æ‹’ç»
                            </button>
                            <button
                              onClick={() => {
                                console.log('ç‚¹å‡»æ‰¹å‡†æŒ‰é’®ï¼Œç”³è¯·ID:', expense.id)
                                console.log('å½“å‰ç”¨æˆ·:', user)
                                handleApproval(expense.id, 'approve', 'åŒæ„ç”³è¯·')
                              }}
                              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium transition-colors duration-200"
                            >
                              âœ… æ‰¹å‡†
                            </button>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )
          ) : activeTab === 'myExpenses' ? (
            // æˆ‘çš„ç”³è¯·å†…å®¹
            <div className="space-y-6">
              {/* å¿«é€Ÿæ“ä½œ */}
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6">
                <h4 className="text-lg font-semibold text-gray-900 mb-4">å¿«é€Ÿæ“ä½œ</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <button
                    onClick={() => setShowExpenseModal(true)}
                    className="bg-white border-2 border-blue-200 rounded-lg p-4 hover:border-blue-300 hover:shadow-md transition-all duration-200 text-center"
                  >
                    <div className="text-3xl mb-2">ğŸ“</div>
                    <div className="text-sm font-medium text-gray-900">æäº¤ç”³è¯·</div>
                  </button>
                  <div className="bg-white border-2 border-gray-200 rounded-lg p-4 text-center opacity-50">
                    <div className="text-3xl mb-2">ğŸ‘¥</div>
                    <div className="text-sm font-medium text-gray-500">æ·»åŠ å®¢æˆ·</div>
                  </div>
                  <div className="bg-white border-2 border-gray-200 rounded-lg p-4 text-center opacity-50">
                    <div className="text-3xl mb-2">ğŸ“±</div>
                    <div className="text-sm font-medium text-gray-500">è®¾å¤‡ç®¡ç†</div>
                  </div>
                  <div className="bg-white border-2 border-gray-200 rounded-lg p-4 text-center opacity-50">
                    <div className="text-3xl mb-2">ğŸ“Š</div>
                    <div className="text-sm font-medium text-gray-500">æŸ¥çœ‹æŠ¥å‘Š</div>
                  </div>
                </div>
              </div>

              {/* æˆ‘çš„ç”³è¯·åˆ—è¡¨ */}
              <div>
                <div className="flex justify-between items-center mb-4">
                  <h4 className="text-lg font-semibold text-gray-900">æˆ‘çš„ç”³è¯·è®°å½•</h4>
                  <button
                    onClick={() => setShowExpenseModal(true)}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center space-x-2"
                  >
                    <span>+</span>
                    <span>æäº¤æ–°ç”³è¯·</span>
                  </button>
                </div>
                {expenses.filter(exp => exp.created_by === user.id).length === 0 ? (
                  <div className="text-center py-12 bg-gray-50 rounded-lg">
                    <div className="text-6xl mb-4">ğŸ“</div>
                    <h3 className="text-lg font-medium text-gray-900 mb-2">æš‚æ— ç”³è¯·è®°å½•</h3>
                    <p className="text-gray-500 mb-4">æ‚¨è¿˜æ²¡æœ‰æäº¤è¿‡ä»»ä½•ç”³è¯·</p>
                    <button
                      onClick={() => setShowExpenseModal(true)}
                      className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200"
                    >
                      ç«‹å³æäº¤ç”³è¯·
                    </button>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {expenses.filter(exp => exp.created_by === user.id).map((expense) => (
                      <div key={expense.id} className="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-all duration-300">
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <div className="flex items-center space-x-4 mb-4">
                              <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <span className="text-purple-600 font-medium">
                                  {expense.creator?.name?.charAt(0) || 'U'}
                                </span>
                              </div>
                              <div className="flex-1">
                                <div className="flex items-center space-x-2 mb-1">
                                  <h4 className="font-medium text-gray-900">{expense.creator?.name || 'æœªçŸ¥ç”³è¯·äºº'}</h4>
                                  <span className="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded-full">ğŸ‘¨â€ğŸ’¼ ç»„é•¿</span>
                                </div>
                                <div className="flex items-center space-x-4 text-sm text-gray-500">
                                  <span>ğŸ¢ {expense.team?.name || 'æœªçŸ¥å›¢é˜Ÿ'}</span>
                                  <span>ğŸ“… {new Date(expense.applied_at).toLocaleDateString()}</span>
                                </div>
                              </div>
                              <div className="text-right">
                                <div className="text-sm text-gray-500 mb-1">å½“å‰å®¡æ‰¹äºº</div>
                                <div className="flex items-center space-x-2">
                                  <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span className="text-blue-600 font-medium text-sm">ğŸ‘¨â€ğŸ’»</span>
                                  </div>
                                  <span className="text-sm font-medium text-gray-900">ä¸»ç®¡</span>
                                  <span className="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full">ğŸ‘¨â€ğŸ’» ä¸»ç®¡</span>
                                </div>
                              </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-6 mb-4">
                              <div>
                                <span className="text-sm font-medium text-gray-600">ç”³è¯·é‡‘é¢:</span>
                                <p className="text-xl font-bold text-gray-900">Â¥{expense.amount}</p>
                              </div>
                              <div>
                                <span className="text-sm font-medium text-gray-600">ç”¨é€”è¯´æ˜:</span>
                                <p className="text-sm text-gray-900">{expense.purpose}</p>
                              </div>
                            </div>
                            
                            {expense.notes && (
                              <div className="mb-4">
                                <span className="text-sm font-medium text-gray-600">å¤‡æ³¨:</span>
                                <p className="text-sm text-gray-900">{expense.notes}</p>
                              </div>
                            )}
                            
                            {/* ç”³è¯·çŠ¶æ€ */}
                            <div className="flex items-center space-x-2">
                              <span className="text-sm font-medium text-gray-600">ç”³è¯·çŠ¶æ€:</span>
                              <span className={`px-3 py-1 text-sm font-medium rounded-full ${
                                expense.status === 'waiting_supervisor' ? 'bg-yellow-100 text-yellow-800' :
                                expense.status === 'waiting_finance' ? 'bg-blue-100 text-blue-800' :
                                expense.status === 'paid' ? 'bg-green-100 text-green-800' :
                                expense.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                'bg-gray-100 text-gray-800'
                              }`}>
                                {expense.status === 'waiting_supervisor' ? 'â³ å¾…ä¸»ç®¡å®¡æ‰¹' :
                                 expense.status === 'waiting_finance' ? 'ğŸ’° å¾…è´¢åŠ¡å®¡æ‰¹' :
                                 expense.status === 'paid' ? 'âœ… å·²æ”¯ä»˜' :
                                 expense.status === 'rejected' ? 'âŒ å·²æ‹’ç»' :
                                 expense.status}
                              </span>
                            </div>
                          </div>
                          
                          {/* æ“ä½œæŒ‰é’® */}
                          <div className="flex flex-col space-y-3 ml-6">
                            <button
                              onClick={() => openModal(expense)}
                              className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm font-medium transition-colors duration-200"
                            >
                              ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          ) : (
            // å®¢æˆ·ç®¡ç†å†…å®¹
            customers.length === 0 ? (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">ğŸ‘¥</div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">æš‚æ— å®¢æˆ·æ•°æ®</h3>
                <p className="text-gray-500">è¯·å…ˆæ·»åŠ å®¢æˆ·ä¿¡æ¯</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {customers.map((customer) => (
                  <div key={customer.id} className="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-all duration-300">
                    <div className="flex items-center space-x-3 mb-4">
                      <div className="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                        {customer.name?.charAt(0) || 'C'}
                      </div>
                      <div>
                        <h4 className="font-medium text-gray-900">{customer.name}</h4>
                        <p className="text-sm text-gray-500">{customer.company}</p>
                      </div>
                    </div>
                    
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600">ç”µè¯:</span>
                        <span>{customer.phone || '-'}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">é‚®ç®±:</span>
                        <span>{customer.email || '-'}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">é¢„ç®—:</span>
                        <span className="font-medium">Â¥{customer.budget || 0}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">çŠ¶æ€:</span>
                        <span className={`px-2 py-1 rounded-full text-xs ${
                          customer.status === 'active' ? 'bg-green-100 text-green-800' :
                          customer.status === 'inactive' ? 'bg-gray-100 text-gray-800' :
                          'bg-yellow-100 text-yellow-800'
                        }`}>
                          {customer.status === 'active' ? 'æ´»è·ƒ' : 
                           customer.status === 'inactive' ? 'éæ´»è·ƒ' : 'æ½œåœ¨'}
                        </span>
                      </div>
                    </div>
                    
                    {customer.notes && (
                      <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p className="text-sm text-gray-600">{customer.notes}</p>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )
          )}
        </div>
      </div>

      {/* è¯¦æƒ…æ¨¡æ€æ¡† */}
      {showModal && selectedExpense && (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div className="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onClick={() => setShowModal(false)}></div>
            
            <div className="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
              <div className="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div className="sm:flex sm:items-start">
                  <div className="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                    <span className="text-blue-600 text-lg">ğŸ“‹</span>
                  </div>
                  <div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                    <h3 className="text-lg leading-6 font-medium text-gray-900 mb-4">
                      ç”³è¯·è¯¦æƒ…
                    </h3>
                    <div className="space-y-3">
                      <div className="flex justify-between">
                        <span className="font-medium text-gray-600">ç”³è¯·äºº:</span>
                        <span>{selectedExpense.creator?.name}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="font-medium text-gray-600">é‡‘é¢:</span>
                        <span className="font-bold">Â¥{selectedExpense.amount}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="font-medium text-gray-600">ç”¨é€”:</span>
                        <span>{selectedExpense.purpose}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="font-medium text-gray-600">ç”³è¯·æ—¶é—´:</span>
                        <span>{new Date(selectedExpense.applied_at).toLocaleString()}</span>
                      </div>
                      
                      {/* è´¢åŠ¡ä¿¡æ¯ */}
                      {selectedExpense.attachments && (
                        <>
                          <div className="border-t pt-3 mt-3">
                            <h4 className="font-medium text-gray-800 mb-2">ğŸ’° è´¢åŠ¡ä¿¡æ¯</h4>
                            <div className="space-y-2">
                              <div className="flex justify-between">
                                <span className="text-sm text-gray-600">ä»˜æ¬¾æ–¹å¼:</span>
                                <span className="text-sm">{selectedExpense.attachments.paymentMethod || 'æœªå¡«å†™'}</span>
                              </div>
                              {selectedExpense.attachments.payeeName && (
                                <div className="flex justify-between">
                                  <span className="text-sm text-gray-600">æ”¶æ¬¾äºº:</span>
                                  <span className="text-sm">{selectedExpense.attachments.payeeName}</span>
                                </div>
                              )}
                              {selectedExpense.attachments.payeeContact && (
                                <div className="flex justify-between">
                                  <span className="text-sm text-gray-600">è”ç³»æ–¹å¼:</span>
                                  <span className="text-sm">{selectedExpense.attachments.payeeContact}</span>
                                </div>
                              )}
                              {selectedExpense.attachments.payeeAccount && (
                                <div className="flex justify-between">
                                  <span className="text-sm text-gray-600">æ”¶æ¬¾è´¦å·:</span>
                                  <span className="text-sm font-mono text-xs">{selectedExpense.attachments.payeeAccount}</span>
                                </div>
                              )}
                              {selectedExpense.attachments.payeeBank && (
                                <div className="flex justify-between">
                                  <span className="text-sm text-gray-600">å¼€æˆ·é“¶è¡Œ:</span>
                                  <span className="text-sm">{selectedExpense.attachments.payeeBank}</span>
                                </div>
                              )}
                            </div>
                          </div>
                          
                          {/* å›¾ç‰‡é¢„è§ˆ */}
                          {selectedExpense.attachments.receiptImageUrl && (
                            <div className="border-t pt-3 mt-3">
                              <h4 className="font-medium text-gray-800 mb-2">ğŸ“· å‡­è¯å›¾ç‰‡</h4>
                              <div className="text-center">
                                <img 
                                  src={selectedExpense.attachments.receiptImageUrl} 
                                  alt="å‡­è¯å›¾ç‰‡"
                                  className="max-w-full h-auto max-h-64 rounded-lg border border-gray-200 shadow-sm mx-auto"
                                  onError={(e) => {
                                    e.target.style.display = 'none'
                                    e.target.nextSibling.style.display = 'block'
                                  }}
                                />
                                <div className="hidden text-sm text-gray-500 mt-2">
                                  å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                  {selectedExpense.attachments.receiptFileName || 'æœªçŸ¥æ–‡ä»¶å'}
                                </div>
                              </div>
                            </div>
                          )}
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              <div className="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button
                  type="button"
                  className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm"
                  onClick={() => setShowModal(false)}
                >
                  å…³é—­
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ç”³è¯·è¡¨å•æ¨¡æ€æ¡† */}
      {showExpenseModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div className="p-6">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold text-gray-900">æäº¤ç”³è¯·</h3>
                  <button
                    onClick={() => setShowExpenseModal(false)}
                    className="text-gray-400 hover:text-gray-600"
                  >
                    âœ•
                  </button>
                </div>

                <div className="space-y-4">
                  {/* æ­¥éª¤æŒ‡ç¤ºå™¨ */}
                  <div className="flex items-center justify-center space-x-2 mb-6">
                    <div className={`flex items-center space-x-2 ${expenseStep >= 1 ? 'text-blue-600' : 'text-gray-400'}`}>
                      <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium ${
                        expenseStep >= 1 ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-400'
                      }`}>
                        1
                      </div>
                      <span className="text-xs font-medium">åŸºæœ¬ä¿¡æ¯</span>
                    </div>
                    <div className={`w-4 h-1 ${expenseStep >= 2 ? 'bg-blue-600' : 'bg-gray-200'}`}></div>
                    <div className={`flex items-center space-x-2 ${expenseStep >= 2 ? 'text-blue-600' : 'text-gray-400'}`}>
                      <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium ${
                        expenseStep >= 2 ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-400'
                      }`}>
                        2
                      </div>
                      <span className="text-xs font-medium">è¯¦ç»†ä¿¡æ¯</span>
                    </div>
                    <div className={`w-4 h-1 ${expenseStep >= 3 ? 'bg-blue-600' : 'bg-gray-200'}`}></div>
                    <div className={`flex items-center space-x-2 ${expenseStep >= 3 ? 'text-blue-600' : 'text-gray-400'}`}>
                      <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium ${
                        expenseStep >= 3 ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-400'
                      }`}>
                        3
                      </div>
                      <span className="text-xs font-medium">è´¢åŠ¡ä¿¡æ¯</span>
                    </div>
                  </div>

                  <form onSubmit={handleSubmitExpense}>
                    {/* ç¬¬1æ­¥ï¼šåŸºæœ¬ä¿¡æ¯ */}
                    {expenseStep === 1 && (
                      <div className="space-y-4">
                        <div className="text-center mb-4">
                          <h4 className="text-md font-semibold text-gray-900 mb-1">é€‰æ‹©ç”³è¯·ç±»å‹å’Œé‡‘é¢</h4>
                          <p className="text-sm text-gray-600">è¯·é€‰æ‹©æ‚¨çš„ç”³è¯·ç±»å‹å¹¶è¾“å…¥é‡‘é¢</p>
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">ç”³è¯·å¤§ç±»</label>
                          <select
                            value={expenseForm.category}
                            onChange={(e) => {
                              const category = e.target.value
                              setExpenseForm({
                                ...expenseForm, 
                                category: category,
                                type: '' // é‡ç½®å°ç±»å‹
                              })
                            }}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          >
                            <option value="">è¯·é€‰æ‹©ç”³è¯·å¤§ç±»</option>
                            {Object.entries(expenseCategories).map(([key, category]) => (
                              <option key={key} value={key}>
                                {category.icon} {category.label}
                              </option>
                            ))}
                          </select>
                        </div>
                        
                        {expenseForm.category && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">å…·ä½“ç±»å‹</label>
                            <select
                              value={expenseForm.type}
                              onChange={(e) => setExpenseForm({...expenseForm, type: e.target.value})}
                              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            >
                              <option value="">è¯·é€‰æ‹©å…·ä½“ç±»å‹</option>
                              {expenseCategories[expenseForm.category]?.types.map((type) => (
                                <option key={type.value} value={type.value}>
                                  {type.icon} {type.label}
                                </option>
                              ))}
                            </select>
                          </div>
                        )}
                        
                        {expenseForm.category && expenseForm.type && (
                          <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div className="flex items-center">
                              <span className="text-blue-600 text-sm">
                                {expenseCategories[expenseForm.category]?.icon} {expenseForm.category} - {expenseCategories[expenseForm.category]?.types.find(t => t.value === expenseForm.type)?.icon} {expenseForm.type}
                              </span>
                            </div>
                          </div>
                        )}
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">ç”³è¯·é‡‘é¢ (å…ƒ)</label>
                          <div className="relative">
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                              <span className="text-gray-500">Â¥</span>
                            </div>
                            <input
                              type="number"
                              step="0.01"
                              min="0"
                              value={expenseForm.amount}
                              onChange={(e) => setExpenseForm({...expenseForm, amount: e.target.value})}
                              className="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="è¯·è¾“å…¥é‡‘é¢"
                              required
                            />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* ç¬¬2æ­¥ï¼šè¯¦ç»†ä¿¡æ¯ */}
                    {expenseStep === 2 && (
                      <div className="space-y-4">
                        <div className="text-center mb-4">
                          <h4 className="text-md font-semibold text-gray-900 mb-1">å¡«å†™è¯¦ç»†ä¿¡æ¯</h4>
                          <p className="text-sm text-gray-600">è¯·è¯¦ç»†è¯´æ˜ç”³è¯·ç”¨é€”å’Œç›¸å…³ä¿¡æ¯</p>
                        </div>
                        
                        {/* ç”³è¯·æ‘˜è¦ */}
                        <div className="bg-gray-50 rounded-lg p-3">
                          <h5 className="font-medium text-gray-900 mb-1">ç”³è¯·æ‘˜è¦</h5>
                          <div className="flex items-center space-x-3 text-sm text-gray-600">
                            <span>ç±»å‹: {expenseForm.type}</span>
                            <span>é‡‘é¢: Â¥{expenseForm.amount}</span>
                          </div>
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">ç”¨é€”è¯´æ˜</label>
                          <textarea
                            value={expenseForm.purpose}
                            onChange={(e) => setExpenseForm({...expenseForm, purpose: e.target.value})}
                            rows={3}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="è¯·è¯¦ç»†è¯´æ˜ç”³è¯·ç”¨é€”ï¼ŒåŒ…æ‹¬å…·ä½“é¡¹ç›®ã€æ—¶é—´ã€åœ°ç‚¹ç­‰ä¿¡æ¯"
                            required
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">å¤‡æ³¨</label>
                          <textarea
                            value={expenseForm.note}
                            onChange={(e) => setExpenseForm({...expenseForm, note: e.target.value})}
                            rows={2}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="å…¶ä»–éœ€è¦è¯´æ˜çš„ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"
                          />
                        </div>
                      </div>
                    )}

                    {/* ç¬¬3æ­¥ï¼šè´¢åŠ¡ä¿¡æ¯ */}
                    {expenseStep === 3 && (
                      <div className="space-y-4">
                        <div className="text-center mb-4">
                          <h4 className="text-md font-semibold text-gray-900 mb-1">å¡«å†™è´¢åŠ¡ä¿¡æ¯</h4>
                          <p className="text-sm text-gray-600">è¯·å¡«å†™ä»˜æ¬¾æ–¹å¼å’Œæ”¶æ¬¾äººä¿¡æ¯</p>
                        </div>
                        
                        {/* ç”³è¯·æ‘˜è¦ */}
                        <div className="bg-gray-50 rounded-lg p-3">
                          <h5 className="font-medium text-gray-900 mb-1">ç”³è¯·æ‘˜è¦</h5>
                          <div className="flex items-center space-x-2 text-sm text-gray-600">
                            <span>ç±»å‹: {expenseForm.type}</span>
                            <span>é‡‘é¢: Â¥{expenseForm.amount}</span>
                            <span>ç”¨é€”: {expenseForm.purpose}</span>
                          </div>
                        </div>
                        
                        {/* ä»˜æ¬¾æ–¹å¼ */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">ä»˜æ¬¾æ–¹å¼</label>
                          <select
                            value={expenseForm.paymentMethod}
                            onChange={(e) => setExpenseForm({...expenseForm, paymentMethod: e.target.value})}
                            className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="é“¶è¡Œè½¬è´¦">ğŸ¦ é“¶è¡Œè½¬è´¦</option>
                            <option value="æ”¯ä»˜å®">ğŸ’™ æ”¯ä»˜å®</option>
                            <option value="å¾®ä¿¡æ”¯ä»˜">ğŸ’š å¾®ä¿¡æ”¯ä»˜</option>
                            <option value="USDT">â‚® USDT</option>
                            <option value="ç°é‡‘">ğŸ’µ ç°é‡‘</option>
                            <option value="æ”¯ç¥¨">ğŸ“„ æ”¯ç¥¨</option>
                          </select>
                        </div>
                        
                        {/* æ”¶æ¬¾äººä¿¡æ¯ */}
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">æ”¶æ¬¾äººå§“å *</label>
                            <input
                              type="text"
                              value={expenseForm.payeeName}
                              onChange={(e) => setExpenseForm({...expenseForm, payeeName: e.target.value})}
                              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="è¯·è¾“å…¥æ”¶æ¬¾äººå§“å"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">è”ç³»æ–¹å¼ *</label>
                            <input
                              type="text"
                              value={expenseForm.payeeContact}
                              onChange={(e) => setExpenseForm({...expenseForm, payeeContact: e.target.value})}
                              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="æ‰‹æœºå·æˆ–é‚®ç®±"
                              required
                            />
                          </div>
                        </div>
                        
                        {/* é“¶è¡Œä¿¡æ¯ */}
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">å¼€æˆ·é“¶è¡Œ *</label>
                            <input
                              type="text"
                              value={expenseForm.payeeBank}
                              onChange={(e) => setExpenseForm({...expenseForm, payeeBank: e.target.value})}
                              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="å¦‚: ä¸­å›½å·¥å•†é“¶è¡Œ"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">é“¶è¡Œè´¦å· *</label>
                            <input
                              type="text"
                              value={expenseForm.payeeAccount}
                              onChange={(e) => setExpenseForm({...expenseForm, payeeAccount: e.target.value})}
                              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="è¯·è¾“å…¥é“¶è¡Œè´¦å·"
                              required
                            />
                          </div>
                        </div>
                        
                        {/* å‡­è¯ä¸Šä¼  */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">ä¸Šä¼ å‡­è¯ *</label>
                          <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <div className="text-gray-400 mb-2">
                              <svg className="mx-auto h-12 w-12" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                              </svg>
                            </div>
                            <div className="text-sm text-gray-600 mb-2">ç‚¹å‡»ä¸Šä¼ å‘ç¥¨ã€æ”¶æ®ç­‰å‡­è¯</div>
                            <div className="text-xs text-gray-500">æ”¯æŒ JPGã€PNG æ ¼å¼</div>
                            <input
                              type="file"
                              accept="image/*"
                              onChange={async (e) => {
                                const file = e.target.files[0]
                                if (file) {
                                  try {
                                    // å…ˆæ˜¾ç¤ºæœ¬åœ°é¢„è§ˆ
                                    setExpenseForm({...expenseForm, receiptImage: file})
                                    const reader = new FileReader()
                                    reader.onload = (e) => {
                                      setExpenseForm({...expenseForm, receiptImage: file, receiptImageUrl: e.target.result})
                                    }
                                    reader.readAsDataURL(file)
                                    
                                    // ä¸Šä¼ åˆ°æœåŠ¡å™¨è·å–çœŸå®URL
                                    const uploadResult = await databaseService.uploadImage(file, 'receipts')
                                    setExpenseForm(prevForm => ({...prevForm, 
                                      receiptImage: file, 
                                      receiptImageUrl: uploadResult.url,
                                      receiptImagePath: uploadResult.path
                                    }))
                                  } catch (error) {
                                    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)
                                    alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•')
                                  }
                                }
                              }}
                              className="hidden"
                              id="receipt-upload"
                            />
                            <label htmlFor="receipt-upload" className="mt-2 inline-block bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 cursor-pointer">
                              é€‰æ‹©æ–‡ä»¶
                            </label>
                            {expenseForm.receiptImageUrl && (
                              <div className="mt-2">
                                <img 
                                  src={expenseForm.receiptImageUrl} 
                                  alt="å‡­è¯é¢„è§ˆ"
                                  className="max-w-full h-auto max-h-32 rounded-lg border border-gray-200 mx-auto"
                                />
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    )}

                    {/* æŒ‰é’®åŒºåŸŸ */}
                    <div className="flex justify-between pt-4">
                      <button
                        type="button"
                        onClick={() => setShowExpenseModal(false)}
                        className="px-4 py-2 text-gray-600 hover:text-gray-800"
                      >
                        å–æ¶ˆ
                      </button>
                      
                      <div className="flex space-x-3">
                        {expenseStep > 1 && (
                          <button
                            type="button"
                            onClick={() => setExpenseStep(expenseStep - 1)}
                            className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                          >
                            â† ä¸Šä¸€æ­¥
                          </button>
                        )}
                        
                        {expenseStep < 3 ? (
                          <button
                            type="button"
                            onClick={() => setExpenseStep(expenseStep + 1)}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                          >
                            ä¸‹ä¸€æ­¥ â†’
                          </button>
                        ) : (
                          <button
                            type="submit"
                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                          >
                            æäº¤ç”³è¯·
                          </button>
                        )}
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

    </div>
  )
}
