# 数据库清理说明

## 问题原因

您遇到的"Unable to delete rows as one of them is currently referenced by a foreign key constraint"错误是因为：

1. **外键约束** - `followups`表通过`customer_id`字段引用了`customers`表
2. **级联删除** - 直接删除客户记录会被外键约束阻止
3. **数据完整性** - 数据库保护引用完整性，防止孤立记录

## 解决方案

我为您提供了两个清理脚本：

### 方案1：只清理客户数据（推荐）

**文件：** `cleanup_customers_only.sql`

**清理内容：**
- 删除所有跟进记录（`followups`表）
- 删除所有客户记录（`customers`表）
- 保留其他数据（用户、团队、支出等）

**执行步骤：**
1. 打开Supabase控制台
2. 进入SQL编辑器
3. 复制`cleanup_customers_only.sql`的内容
4. 执行SQL脚本

### 方案2：清理所有测试数据

**文件：** `cleanup_test_data.sql`

**清理内容：**
- 删除所有测试数据
- 包括：公司、用户、团队、客户、支出、设备等
- 按正确的依赖顺序删除

**执行步骤：**
1. 打开Supabase控制台
2. 进入SQL编辑器
3. 复制`cleanup_test_data.sql`的内容
4. 执行SQL脚本

## 执行建议

### 推荐使用方案1
- 只清理客户相关数据
- 保留用户和团队结构
- 风险较小

### 如果需要完全重置
- 使用方案2清理所有数据
- 然后重新执行`supabase_setup.sql`创建基础数据

## 执行后效果

执行清理脚本后：
- 员工端客户列表将完全清空
- 组长端客户列表将完全清空
- 管理员可以重新添加客户
- 系统恢复正常运行状态

## 注意事项

1. **备份重要数据** - 执行前请确保没有重要数据需要保留
2. **测试环境** - 建议先在测试环境执行
3. **权限确认** - 确保有足够的数据库权限
4. **执行顺序** - 必须按照脚本中的顺序执行

## 预防措施

为了避免将来再次遇到此问题，建议：

1. **使用软删除** - 通过`is_deleted`字段标记删除
2. **级联删除** - 修改外键约束支持级联删除
3. **应用层删除** - 通过应用代码处理删除逻辑

## 联系支持

如果遇到任何问题，请检查：
1. SQL语法是否正确
2. 数据库权限是否充足
3. 外键约束是否已正确处理

